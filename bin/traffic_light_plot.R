#!/usr/bin/env Rscript

library(argparser, quietly = TRUE)
library(dplyr, quietly = TRUE)
library(ggplot2, quietly = TRUE)
library(ggnewscale, quietly = TRUE)
library(readr, quietly = TRUE)
library(stringr, quietly = TRUE)
library(tidyr, quietly = TRUE)

my_parser <-
  arg_parser("Run-wide QC based on files generated by iVar and summarizecoverage.sh.") %>%
  add_argument("name", help = "Name of run", default = "mad_river") %>%
  add_argument("--ivar_tsv",
               help = "TSV files from `ivar variants`.",
               nargs = Inf,
               type = "character") %>%
  add_argument("--cov", help = "Coverage summary file", type = "character") %>%
  add_argument("--out_type", help = "Type of output file to write a ggplot2 graph to.", default = "pdf")

my_args <- parse_args(my_parser)

my_args[["ivar_tsv"]] <-
  my_args[["ivar_tsv"]] %>% str_subset(".tsv")

if (length(my_args[["ivar_tsv"]]) == 0) {
  print(my_parser)
  stop("no iVar tsv files were given!", call. = FALSE)
}

sample_names <- my_args[["ivar_tsv"]] %>%
  lapply(function (x) {
    gsub(".variants.tsv", "", basename(x))
  })

if (is.na(my_args[["cov"]]) ||
    !str_ends(my_args[["cov"]], ".txt")) {
  print(my_parser)
  stop("input coverage summary file is not in txt format!")
}

coverage_summary <-
  read_delim(my_args[["cov"]], "\t", trim_ws = TRUE) %>%
  mutate(sample_name = str_remove(`#Sample`, "_basecov_border5")) %>% 
  select(!`#Sample`)

# if (!setequal(unlist(sample_names), coverage_summary$sample_name)) {
#   print(setdiff(unlist(sample_names), coverage_summary$sample_name))
#   stop("sample names don't match! (check samples listed above)", call. = FALSE)
# }

coverage_summarized <- data.frame(sample_name = matrix(unlist(sample_names), byrow = TRUE)) %>% 
  full_join(coverage_summary, by = c("sample_name")) %>% 
  replace(is.na(.), 0) %>% 
  # transmute(sample_name, AvgCov, coverage = `%>=20x`)
  mutate(
    coverage_bin = case_when(`%>=20x` >= 80 ~ "80-100%", `%>=20x` >= 50 ~ "50-79%", TRUE ~ "0-49%"),
    coverage_bin = factor(coverage_bin, levels = c("80-100%", "50-79%", "0-49%"))
  ) %>%
  select(sample_name, AvgCov, coverage_bin)

run_tsvs <-
  lapply(
    my_args[["ivar_tsv"]],
    read_tsv,
    col_types = cols(
      REGION = col_character(),
      POS = col_double(),
      REF = col_character(),
      ALT = col_character(),
      REF_DP = col_double(),
      REF_RV = col_double(),
      ALT_DP = col_double(),
      ALT_RV = col_double(),
      ALT_QUAL = col_double(),
      ALT_FREQ = col_double(),
      TOTAL_DP = col_double(),
      PVAL = col_double(),
      PASS = col_logical(),
      GFF_FEATURE = col_character(),
      REF_CODON = col_character(),
      REF_AA = col_character(),
      ALT_CODON = col_character(),
      ALT_AA = col_character()
    ),
    trim_ws = TRUE
  )

run_data <- data.frame()

for (i in 1:length(run_tsvs)) {
  if (nrow(run_tsvs[i] %>% data.frame()) == 0) {
    next
  }
  run_data <-
    run_data %>%
    bind_rows(run_tsvs[i] %>%
                data.frame() %>%
                mutate(sample_name =
                         as.character(sample_names[i])))
}

run_data <- run_data %>% mutate(
  frequency_bin = case_when(
    between(ALT_FREQ, 0.4, 0.6) ~ "40-60%",
    between(ALT_FREQ, 0.2, 0.8) ~ "20-80%",
    TRUE ~ "0-100%"
  ),
  frequency_bin = factor(frequency_bin, levels = c("0-100%", "20-80%", "40-60%"))
)

run_data_summarized <-
  run_data %>%
  group_by(sample_name, frequency_bin) %>%
  summarize(count = n())

graph_data <-
  full_join(coverage_summarized, run_data_summarized, by = c("sample_name")) %>%
  replace_na(list(frequency_bin = "0-100%", count = 0))

graph_scale_factor <-
  (
    graph_data %>%
      group_by(sample_name) %>%
      summarize(count = sum(count)) %>%
      select(count) %>%
      max()
  ) / (graph_data %>%
         select(AvgCov) %>%
         max())

ggsave(
  paste(my_args[["name"]], "summary", my_args[["out_type"]], sep = "."),
  plot = ggplot(data = graph_data, aes(x = sample_name)) +
    geom_col(
      aes(y = count, fill = frequency_bin),
      size = 0.5,
      color = "black"
    ) +
    # scale_fill_brewer("Alt. Freq.", palette = "RdYlGn", direction = -1) +
    scale_fill_manual("Alt. Freq.", values = c("#91cf60", "#ffffbf", "#fc8d59")) +
    new_scale_fill() +
    geom_line(aes(
      y = AvgCov * graph_scale_factor, group = 1
    )) +
    geom_point(
      aes(y = AvgCov * graph_scale_factor, fill = coverage_bin),
      size = 3,
      stroke = 1,
      shape = 21
    ) +
    scale_y_continuous(
      sec.axis = sec_axis( ~ . / graph_scale_factor, name =
                             "Mean Depth of Coverage")
    ) +
    scale_fill_manual("Coverage (%)", values = c("green", "yellow", "red")) +
    labs(
      title = my_args[["name"]],
      subtitle = "Variant and Coverage Summary",
      x = "Sample",
      y = "Variants"
    ) +
    theme_minimal() +
    theme(
      axis.text.x = element_text(angle = 45, hjust = 1),
      plot.margin = unit(c(0.5, 0.5, 0.5, 1), "in"),
      # aspect.ratio = 2 / (length(sample_names) / 10),
    ),
  height = 6,
  width = 3 * (length(sample_names) / 10) + 3,
  units = "in",
  limitsize = FALSE
)
